# IMè®¾è®¡

æ³¨æ„ï¼ŒVerilogæ˜¯æ²¡æœ‰ROMè¿™ç§ä¸œè¥¿çš„ï¼Œå³å·²ç»æ­å»ºå®Œçš„å­˜å‚¨å™¨æ¨¡å—ï¼Œéœ€è¦è‡ªè¡Œè®¾è®¡

**Key**ï¼šè¦ç”Ÿäº§åŒ¹é…éœ€æ±‚æ•°é‡çš„32ä½å¯„å­˜å™¨çš„é˜µåˆ—

è€Œlogisimä¸­å¯¼å…¥code.txtä¸­æœºå™¨ç çš„è¿‡ç¨‹ï¼ŒISEä¸­éœ€è¦ç”¨`$readmemh`

## `$readmemh`

**åŠŸèƒ½**ï¼š è¯»å–æ–‡ä»¶åˆ°å­˜å‚¨å™¨

**æ ¼å¼ï¼š**

- `$readmemh("<æ•°æ®æ–‡ä»¶å>",<å­˜å‚¨å™¨å>);`
- `$readmemh("<æ•°æ®æ–‡ä»¶å>", <å­˜å‚¨å™¨å>, <èµ·å§‹åœ°å€>);`
- `$readmemh("<æ•°æ®æ–‡ä»¶å>", <å­˜å‚¨å™¨å>, <èµ·å§‹åœ°å€>, <ç»“æŸåœ°å€>);`

åŠŸèƒ½ï¼šÂ `$readmemh`Â å‡½æ•°ä¼šæ ¹æ®ç»å¯¹/ç›¸å¯¹è·¯å¾„æ‰¾åˆ°éœ€è¦è®¿é—®çš„æ–‡ä»¶ï¼ŒæŒ‰ç…§ ASCII çš„è§£ç æ–¹å¼å°†æ–‡ä»¶å­—èŠ‚æµè§£ç å¹¶è¯»å…¥å®¹å™¨ã€‚æ–‡ä»¶ä¸­çš„å†…å®¹å¿…é¡»æ˜¯åå…­è¿›åˆ¶æ•°å­— 0~f æˆ–æ˜¯ä¸å®šå€¼ xï¼Œé«˜é˜»å€¼ zï¼ˆå­—æ¯å¤§å°å†™å‡å¯ï¼‰ï¼Œä¸éœ€è¦å‰å¯¼ 0xï¼Œä¸åŒçš„æ•°ç”¨ç©ºæ ¼æˆ–æ¢è¡Œéš”å¼€ã€‚å‡è®¾å­˜å‚¨å™¨åä¸º arrï¼Œèµ·å§‹åœ°å€ä¸º sï¼Œç»“æŸåœ°å€ä¸º dï¼Œé‚£ä¹ˆæ–‡ä»¶ä¸­ç”¨ç©ºæ ¼éš”å¼€çš„æ•°å­—ä¼šä¾æ¬¡è¯»å…¥åˆ° arr[s],arr[s+1]... åˆ° arr[d]ã€‚**å‡å¦‚æ•°å­—çš„ä½æ•°å¤§äºæ•°ç»„å…ƒç´ çš„ä½æ•°ï¼Œé‚£ä¹ˆåªæœ‰ä½ä½ä¼šè¢«è¯»å…¥ï¼Œå‰©ä¸‹çš„é«˜ä½ä¼šè¢«å¿½ç•¥ã€‚**

æ­¤ç³»ç»Ÿä»»åŠ¡ç”¨æ¥ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®åˆ°å­˜å‚¨å™¨ä¸­ï¼Œç±»ä¼¼äº C è¯­è¨€ä¸­çš„ fread å‡½æ•°ã€‚

ä¾‹å¦‚ï¼š

```verilog
module im;
reg[31:0] im_reg[0:2047];
initialbegin$readmemh("code.txt",im_reg);
endendmodule
```

ä»¿çœŸåå³å¯å°† code.txt ä¸­çš„å†…å®¹è¯»å…¥Â `im_reg`Â å­˜å‚¨å™¨ä¸­ã€‚

# æ§åˆ¶å™¨è®¾è®¡

## è®¾è®¡æµç¨‹

 é¦–å…ˆåˆ†æå„ä¸ªéƒ¨ä»¶ä»æ§åˆ¶å™¨ä¸­æ‰€éœ€çš„æ§åˆ¶ä¿¡å·ï¼Œå¹¶å…¨éƒ¨åˆ—ä¸¾å‡ºæ¥ï¼Œæ¯”å¦‚ ALU éœ€è¦æ§åˆ¶å™¨è¾“å‡ºä¸€ä¸ª ALUOp æ¥æ§åˆ¶å…¶æ‰§è¡Œä½•ç§è¿ç®—ã€‚åœ¨ P3 æ—¶ï¼Œå·²ç»å®Œæˆäº†æ§åˆ¶å™¨ç”µè·¯çš„å¸ƒå±€å¸ƒçº¿ï¼Œæ‰€ä»¥åœ¨æ­¤åªéœ€è¦åŠ ä¸Šæ–°å¢æŒ‡ä»¤æ‰€äº§ç”Ÿçš„æ§åˆ¶ä¿¡å·å³å¯ã€‚

 å¯ä»¥åœ¨è®¾è®¡æ–‡æ¡£ä¸­åˆ—ä¸€å¼ è¡¨ï¼Œæ¥è®°å½•æ§åˆ¶å™¨çš„æ˜ å°„é€»è¾‘ã€‚

 è¿™é¡¹å·¥ä½œå¯¹äºåç»­çš„ä»¿çœŸè°ƒè¯•å’Œè¯¾ä¸Šæµ‹è¯•éƒ½éå¸¸æœ‰å¸®åŠ©ã€‚å› ä¸ºä»¿çœŸè°ƒè¯•æ—¶å¯ä»¥é¦–å…ˆæŸ¥çœ‹è¡¨æ ¼æ˜¯å¦æ­£ç¡®ï¼Œå†å»ç¡®è®¤æ˜¯å¦å’Œä»£ç å¯¹åº”ï¼ŒBug ä¸€ç›®äº†ç„¶ã€‚å¯¹äºæ·»åŠ æŒ‡ä»¤ï¼Œåªéœ€åœ¨è¡¨æ ¼åé¢åŠ å…¥æ–°çš„æ“ä½œç å’Œå¯¹åº”çš„æ§åˆ¶ä¿¡å·çš„å€¼ï¼Œå†å°†å…¶æ˜ å°„åˆ° Verilog HDL ä»£ç ä¸­ï¼Œéå¸¸æ–¹ä¾¿ã€‚è‡³äºè¡¨æ ¼çš„å…·ä½“è®¾è®¡ï¼Œåˆ™å› äººè€Œå¼‚ï¼Œå¯ä»¥è®°å½•ä¸‹Â **æŒ‡ä»¤å¯¹åº”çš„æ§åˆ¶ä¿¡å·å¦‚ä½•å–å€¼**ï¼Œä¹Ÿå¯ä»¥è®°å½•ä¸‹**æ§åˆ¶ä¿¡å·æ¯ç§å–å€¼æ‰€å¯¹åº”çš„æŒ‡ä»¤**ï¼Œ

# å®ç°è¿‡ç¨‹

å¯¹ç€Logisimç¿»è¯‘å°±å®Œäº†ï¼Œæ³¨æ„å¯¹MUXçš„å»ºæ¨¡ï¼ˆVerilogæ¯è¿™ç§ä¸œè¥¿ï¼‰

è®©ä»£ç çœ‹èµ·æ¥æ²¡é‚£ä¹ˆå¤æ‚çš„å…³é”®åœ¨äºdatapathï¼Œä¹Ÿå°±æ˜¯æ•°æ®é€šè·¯çš„è®¾è®¡

å…¶å®å°±æ˜¯å°†Logisimé‡Œmainå‡½æ•°è¿å¯¼çº¿çš„å·¥ä½œï¼Œé€šè¿‡å®ä¾‹åŒ–å°†å„ä¸ªæ¨¡å—ä¸²è”èµ·æ¥ã€‚

å…¶ä¸­ï¼Œå¯ä»¥æ³¨æ„å„ä¸ªä¿¡å·ï¼Œinputï¼Œoutputï¼Œwireçš„é€‰å–

ä½†å®æµ‹å¥½åƒå½±å“ä¸å¤§ï¼ˆï¼Ÿï¼‰

å¯¹äºæˆ‘ä¸ªäººç¼–å†™æ¥è¯´

å½“ä¸€ä¸ªä¿¡å·æ˜¯Controllerçš„outputï¼Œå¹¶åªç”¨ä½œå…¶ä»–æ¨¡å—çš„inputæ—¶ï¼Œé‚£ä¹ˆä»¤è¿™ä¸ªä¿¡å·ä¸ºinput

å½“ä¸€ä¸ªä¿¡å·åªæ˜¯Controllerçš„inputï¼Œå¹¶æ˜¯å…¶ä»–æ¨¡å—çš„outputæ—¶ï¼Œé‚£ä¹ˆä»¤è¿™ä¸ªä¿¡å·ä¸ºoutput

å½“ä¸€ä¸ªä¿¡å·æ˜¯æŸä¸ªæ¨¡å—çš„outputï¼ŒåŒæ—¶æ˜¯åˆ«çš„æ¨¡å—çš„inputæ—¶ï¼Œç”¨wireé“¾æ¥

# è°ƒè¯•å»ºè®®

ä»¿çœŸå‡ºç°é«˜é˜»å€¼zä»£è¡¨å¹¶æœªè¿æ¥åˆ°æœ‰æ•ˆè¾“å…¥ä¸Šï¼Œé¦–å…ˆåº”è€ƒè™‘è¿çº¿é—®é¢˜ï¼Œ

ä»¿çœŸå‡ºç°ä¸å®šå€¼xçš„æƒ…å†µæ—¶é¦–å…ˆè€ƒè™‘åˆå§‹åŒ–é—®é¢˜

# è‡ªåŠ¨åŒ–æµ‹è¯•

## Mars

ç»“åˆä¿®æ”¹ç‰ˆMarsï¼Œhelpä¸­æä¾›çš„cmdä»£ç ï¼Œå¤§ä½“å¦‚ä¸‹

`java -jar Mars.jar nc mc CompactDataAtZero [ProgramName.asm] >std.txt`

å¯ä»¥Run I/Oä¿¡æ¯è¾“å…¥åˆ°std.txtæ–‡ä»¶

åŒæ—¶`java -jar Mars.jar nc mc CompactDataAtZero dump HexText .text code.txt [ProgramName.asm]`

å¯ä»¥æŠŠ.textçš„16è¿›åˆ¶æœºå™¨ç è¾“å…¥åˆ°code.txtï¼ˆè¦äº‹å…ˆåˆ›å»ºï¼‰

## Vivado

ä¸ä¼šç”¨å‘½ä»¤è¡Œæ§åˆ¶vivadoä»¿çœŸğŸ˜­, è¯´ä¸å®šè¦å†™è„šæœ¬? ä»¥åå†è¯•è¯•ï¼Œä½†åœ¨è¯¾å ‚ä¸Šåˆæ˜¯ç”¨iseï¼ˆxï¼‰ï¼Œè¦ä¸è¯•è¯•vcsç®—äº†ï¼Œæˆ–è€…çœ‹çœ‹è¯¾å ‚ä¸Šæœ‰iverilogæ²¡æœ‰

~~å› æ­¤åªèƒ½æ¯æ¬¡æ‰‹åŠ¨restartäº†ï¼Œæ³¨æ„ä¸‹æ–‡ä»¶çš„è¯»å–å§~~

é—®é¢˜è§£å†³ï¼Œå¯ä»¥ç”¨vivadoå’Œiverilogä¸¤ç§æ–¹æ³•

iverilogå…·ä½“è§æ•™ç¨‹

vivadoçœ‹:

â€” Solutionï¼šåœ¨Vivadoé™„å¸¦çš„docä¸­æœ‰ä¸€ç« Logic Simulationä¸­æœ‰å¯¹å‘½ä»¤è¡Œé©±åŠ¨çš„æ–¹æ³•ï¼ˆè¦å…ˆè¿›å…¥-mode tclï¼‰ï¼Œæˆ–è€…ç”¨batchmodeé©±åŠ¨tclæ–‡ä»¶ï¼Œtclæ–‡ä»¶çš„å‘½ä»¤å°±æŠŠvivadoé‡Œé¢tcl consoleä¸­çš„å‘½ä»¤æ‹·è´è¿›æ¥å°±å¥½äº†

```cpp
while(1)
{
  //system("D:\\Archive\\cpp\\BUAA_CO\\cmake-build-debug\\BUAA_CO.exe");
  //system("fc std.txt src.txt");
  system("D:\\Archive\\ISE\\Monocycle_CPU\\Monocycle_CPU.sim\\sim_1\\behav\\xsim\\BUAA_CO.exe");
  system("java -jar Mars.jar nc mc CompactDataAtZero dump .text HexText code.txt Test.asm 1> std.txt 2>err.txt");
  printf("Data have been already generated\n");
  system("Vivado -mode batch -source start.tcl");
  //system("open_project D:/Archive/ISE/Monocycle_CPU/Monocycle_CPU.xpr");
  system("cls");
  system("fc /W std.txt src.txt");
  //	system("pause");
  if(system("fc /W std.txt src.txt")) system("pause");
  system("cls");
}
```

### æ–‡ä»¶è¾“å‡º

Key: `$fopen` å’Œ `$dfisplay`

åŒæ—¶è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ¯æ¬¡ä»¿çœŸæ—¶è¦ä¿è¯æ–‡ä»¶ä¸ºå†…å®¹æ¸…ç©ºï¼Œä½†DMå’ŒGRFæ‰§è¡Œè¾“å…¥æ—¶è¦åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šè¾“å…¥

æˆ‘å¯¹æ­¤çš„å¤„ç†æ–¹å¼æ˜¯åœ¨ `$fdisplay`æ¨¡å—ä¸­ä½¿ç”¨â€œa+â€æ–¹å¼æ‰“å¼€ï¼Œåœ¨tbé‡Œé€‰æ‹©â€œwâ€æ–¹å¼æ‰“å¼€

## è‡ªåŠ¨ç”Ÿæˆä¸å¯¹æ‹

### vivado

```cpp
#include<bits/stdc++.h>
using namespace std;
int main()
{
	while(1)
	{
		system("D:\\Archive\\cpp\\BUAA_CO\\cmake-build-debug\\BUAA_CO.exe"); //è¿™ä¸ªæ˜¯è‡ªåŠ¨ç”ŸæˆMIPSä»£ç çš„ç¨‹åºï¼Œçœ‹æƒ…å†µä¿®æ”¹ 
		//system("fc std.txt src.txt");
		
		//å…³äºMIPSçš„commandç›¸å…³åœ¨helpä¸­ä¹Ÿæœ‰
		//è¿™è¾¹å°±æ˜¯ä¸Šé¢æåˆ°çš„ç»“åˆä½“ï¼Œï¼ˆncæ˜¯ä¸ºå¿½è§†copyrightä¿¡æ¯ï¼Œå¯ä»¥åˆ æ‰çœ‹ä¸€ä¸‹å˜åŒ–ï¼‰
		system("java -jar Mars.jar nc mc CompactDataAtZero dump .text HexText code.txt Test.asm 1> std.txt 2>err.txt");
		
		//æç¤ºæ•°æ®ç”ŸæˆæˆåŠŸ
		printf("Data have been already generated\n");
		
		//è°ƒç”¨å…ˆå‰å†™çš„tclæ–‡ä»¶ï¼Œä¾æ¬¡æ¥é©±åŠ¨ä»¿çœŸ
		system("Vivado -mode batch -source start.tcl"); 

		//è¾“å‡ºçš„ä¸œè¥¿æœ‰ç‚¹å¤šï¼Œä¸æ¸…å±çœ‹çš„æœ‰ç‚¹éš¾å—
		system("cls");
		system("fc /W std.txt src.txt");
		//é‡åˆ°ä¸ä¸€æ ·çš„å°±æš‚åœ
		if(system("fc /W std.txt src.txt")) system("pause"); ;

		//æ¸…å±ç”¨çš„
		system("cls");
 	} 

```

tclæ–‡ä»¶é‡Œé¢é•¿è¿™æ ·ï¼ˆæŠŠtcl consoleç›¸å…³ä¿¡æ¯å¤åˆ¶è¿‡æ¥å°±å¥½äº†ï¼‰

`open_project D:/Archive/ISE/Monocycle_CPU/Monocycle_CPU.xpr
update_compile_order -fileset sources_1
launch_simulation`

### iverilog

ç”¨iverilogè‡ªåŠ¨åŒ–ï¼Œä¹Ÿæ›´ç®€å•ä¸€ç‚¹ï¼ŒåŒæ—¶è·‘çš„ä¹Ÿæ›´å¿«ä¸€ç‚¹, é—®é¢˜åœ¨äºiverilogçš„ä»¿çœŸç»“æœä¸iseå’Œvivadoæœ‰æ—¶å€™ä¼šå­˜åœ¨å·®å¼‚ï¼Œä¸€èˆ¬æ˜¯å¤„åœ¨é˜»å¡èµ‹å€¼å’Œéé˜»å¡èµ‹å€¼ä¸Šå¥½åƒã€‚

```cpp
#include<bits/stdc++.h>
using namespace std;
int main()
{
	
	while(1)
	{
		system("D:\\Archive\\cpp\\BUAA_CO\\cmake-build-debug\\BUAA_CO.exe"); 
		system("java -jar Mars.jar nc mc CompactDataAtZero dump .text HexText code.txt Test.asm 1> std.txt 2>err.txt");
		printf("Data have been already generated\n");
		system("iverilog -o a.vvp DM.v IM.v Controller.v datapath.v ALU.v mips.v tb.v GRF.v dasm.v MUX.v PC.v EXT.v NPC.v");
		system("vvp a.vvp");
		system("fc /W std.txt src.txt");
//		system("pause"); 
		if(system("fc /W std.txt src.txt")) system("pause"); 
		system("cls");
 	} 
}
```

# Warning

<aside>
âš ï¸ ä¸è¦å¿˜è®°P1çš„å‘

</aside>

1. ç¬¦å·æ•°çš„ `$signed`
2. forå¾ªç¯ç»Ÿè®¡å˜é‡åœ¨alwayså—ä¸­çš„æ¸…é›¶
3. çœ‹æ¸…æ–°åŠ çš„æŒ‡ä»¤ä¸RegWriteï¼ŒMemWriteï¼ŒSignExt, ALUSrcç­‰çš„å…³ç³»ï¼Œè¦è®°å¾—ä¿®æ”¹
4. è¦è®°å¾—å®ä¾‹åŒ–çš„è¿çº¿

# è¯¾ä¸Š

jrå†™é”™äº†ï¼Œdeäº†è‡³å°‘ä¸€ä¸ªåŠå°æ—¶ ğŸ˜£,ç„¶åå‘ç°æ˜¯å…³äºjrçš„RTLç†è§£é”™è¯¯ï¼Œä»¥åå¤æŸ¥çš„æ—¶å€™ä¸€å®šè¦å¯¹ç€æŒ‡ä»¤é›†å†çœ‹ä¸€éï¼Œå¤ªç¦»è°±äº†ğŸ˜‘

**æ³¨æ„è¦ç‚¹**

1. forå¾ªç¯ä¸­ï¼Œå¾ªç¯æ¬¡æ•°è¦æ˜¯ç¨³å®šçš„ï¼Œå³ä¸Šä¸‹é™è¦æ˜¯å¸¸æ•°ï¼Œä¸èƒ½æ˜¯å¸¸æ•°ï¼ˆä»¿çœŸå€’æ˜¯å¯ä»¥ä»¿çœŸï¼Œå°±æ˜¯è¯„æµ‹çš„æ—¶å€™ä¼šTLEï¼Œè¯´æ˜¯å¦‚æœä¸ç¨³å®šä¸æ»¡è¶³å¯ç»¼åˆçš„è¦æ±‚ï¼‰
2. å¯¹äºå¸¦æ¡ä»¶çš„æŒ‡ä»¤ï¼ˆå°¤å…¶æ˜¯äºbranch and linkç›¸å…³ï¼‰ï¼Œæœ€å¥½åœ¨controlleré‡Œå°±æŠŠç›¸å…³çš„æ¡ä»¶ç”¨ç»„åˆé€»è¾‘è¿›ä¸€æ­¥åˆ¤æ–­ï¼ˆå¦‚å¯¹äºbeqï¼Œå¯ä»¥åœ¨controller ä¼ å…¥ä¸€ä¸ªzeroï¼‰,ç„¶å
    
    ```verilog
    assign beq_w = (op == 6'b000100);
    assign beq = beq & Zero;
    ```
    
    ä¼šæ›´æ–¹ä¾¿æŒ‡ä»¤çš„æ‰§è¡Œ
    

## è¯¾ä¸Šé¢˜

### bnezalc

if GPR[rs] â‰  0

PC = PC + 4 + sign_extend(offset||$0^2$)

else

PC = PC + 4

### slo

$GPR[rt] = GPR[rs]_{31..imm}||~GPR[rs]_{imm-1:0}$

### è®¿å­˜

å¿˜äº†ï¼Œè°ƒå®ŒjræŒ‡ä»¤å°±æ¥ä¸åŠäº†ï¼Œé¢˜éƒ½æ²¡æ€ä¹ˆçœ‹ï¼Œå°±è®°å¾—æœ‰ä¸ªå¾ªç¯å³ç§»
